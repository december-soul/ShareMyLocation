<!DOCTYPE html>
<html>
<head>
    <script
            src="//maps.googleapis.com/maps/api/js?key=AIzaSyC6hHq1nL0Tc7TAcTi38WmYPfq7sEBUPSA&sensor=false">
    </script>
    <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>

    <script>

function format(date) {
        var yyyy = date.getFullYear().toString();
        var mm = (date.getMonth()+1).toString(); // getMonth() is zero-based
        var dd  = date.getDate().toString();
        var HH  = date.getHours().toString();
        var SS  = date.getMinutes().toString();
        var MM  = date.getSeconds().toString();

        mm = mm[1]?mm:"0"+mm[0];
        dd = dd[1]?dd:"0"+dd[0];
        HH = HH[1]?HH:"0"+HH[0];
        MM = MM[1]?MM:"0"+MM[0];
        SS = SS[1]?SS:"0"+SS[0];

        return yyyy + '-' + mm + '-' + dd + ' ' + HH  + ":" + MM + ":" + SS;
   };

function initialize()
{
    var mapProp = {
      center:new google.maps.LatLng(51.508742,-0.120850),
      zoom:5,
      mapTypeId:google.maps.MapTypeId.TERRAIN
      };
    var map=new google.maps.Map(document.getElementById("googleMap"),mapProp);

    $.getJSON("location.json", function(last_location) {

        var timestamp = last_location.time/1000;
        var params = last_location.lat + "," + last_location.lon + "&timestamp=" + timestamp;
        var timezone_url = "https://maps.googleapis.com/maps/api/timezone/json?location=" + params + "&key=AIzaSyC6hHq1nL0Tc7TAcTi38WmYPfq7sEBUPSA"
        $.getJSON(timezone_url, function(timezone_data){
            console.log(timezone_data);
            var fixtime = new Date();
            fixtime.setTime((timestamp + timezone_data.rawOffset + timezone_data.dstOffset) * 1000);
            last_location['time_at_location'] = fixtime;
            var current_location_marker = makeMarker(map, "My last known position", last_location, 'img/hiking.png');
        });

    });
}

function makeMarker(map, title, location, icon_link) {
    var marker_latlng = new google.maps.LatLng(location.lat, location.lon);
    var fixtime = new Date();
    fixtime.setTime(location.time);
    location['fixtime'] = fixtime;
    var title = title + ' (' + fixtime + ')';
    var marker = new google.maps.Marker({
        map: map,
        position: marker_latlng,
        title: title,
        icon: icon_link
    });
    makeInfoWindow(map, marker, title, location)
    return marker;
}
function makeInfoWindow(map, marker, title, location){
    var contentString = '<div class="map-infowindow">';
    contentString += '<h3>' + title + '</h3>';
    contentString += 'UTC Time: ' + location.fixtime.toISOString() +'<br/>';
    contentString += 'Time at location: ' + format(location.time_at_location) + '<br/>';
    contentString += 'Latitude: ' + location.lat +'<br/>';
    contentString += 'Longitude: ' + location.lon +'<br/>';
    contentString += 'Altitude: ' + location.alt +'m<br/>';
    contentString += 'Speed: ' + location.spd +'Km/h<br/>';
    contentString += 'Accurancy: ' + location.acc + 'm</div>';

    var infowindow = new google.maps.InfoWindow({
      content: contentString
    });
    google.maps.event.addListener(marker, 'click', function() {
	    infowindow.open(map,marker);
    });
}

google.maps.event.addDomListener(window, 'load', initialize);
</script>
</head>

<body>
<div id="googleMap" style="width:500px;height:380px;"></div>

</body>
</html>
